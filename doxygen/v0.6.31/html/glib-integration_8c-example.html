<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.9.1"/>
<title>avahi: glib-integration.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">avahi
   &#160;<span id="projectnumber">0.6.31</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.9.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('glib-integration_8c-example.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">glib-integration.c</div>  </div>
</div><!--header-->
<div class="contents">
<p>Example of how to integrate avahi use with GLIB/GTK applications</p>
<div class="fragment"><div class="line"><span class="comment">/***</span></div>
<div class="line"><span class="comment">  This file is part of avahi.</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">  avahi is free software; you can redistribute it and/or modify it</span></div>
<div class="line"><span class="comment">  under the terms of the GNU Lesser General Public License as</span></div>
<div class="line"><span class="comment">  published by the Free Software Foundation; either version 2.1 of the</span></div>
<div class="line"><span class="comment">  License, or (at your option) any later version.</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">  avahi is distributed in the hope that it will be useful, but WITHOUT</span></div>
<div class="line"><span class="comment">  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY</span></div>
<div class="line"><span class="comment">  or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Lesser General</span></div>
<div class="line"><span class="comment">  Public License for more details.</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">  You should have received a copy of the GNU Lesser General Public</span></div>
<div class="line"><span class="comment">  License along with avahi; if not, write to the Free Software</span></div>
<div class="line"><span class="comment">  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307</span></div>
<div class="line"><span class="comment">  USA.</span></div>
<div class="line"><span class="comment">***/</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifdef HAVE_CONFIG_H</span></div>
<div class="line"><span class="preprocessor">#include &lt;config.h&gt;</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;glib.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="client_8h.html">avahi-client/client.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="error_8h.html">avahi-common/error.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;avahi-common/timeval.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="glib-watch_8h.html">avahi-glib/glib-watch.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="glib-malloc_8h.html">avahi-glib/glib-malloc.h</a>&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Callback for Avahi API Timeout Event */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">avahi_timeout_event (AVAHI_GCC_UNUSED <a class="code" href="watch_8h.html#a7c49ec2c98706902366ce0f74958626d">AvahiTimeout</a> *timeout, AVAHI_GCC_UNUSED <span class="keywordtype">void</span> *userdata)</div>
<div class="line">{</div>
<div class="line">    g_message (<span class="stringliteral">&quot;Avahi API Timeout reached!&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Callback for GLIB API Timeout Event */</span></div>
<div class="line"><span class="keyword">static</span> gboolean</div>
<div class="line">avahi_timeout_event_glib (<span class="keywordtype">void</span> *userdata)</div>
<div class="line">{</div>
<div class="line">    GMainLoop *loop = userdata;</div>
<div class="line"></div>
<div class="line">    g_message (<span class="stringliteral">&quot;GLIB API Timeout reached, quitting main loop!&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Quit the application */</span></div>
<div class="line">    g_main_loop_quit (loop);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> FALSE; <span class="comment">/* Don&#39;t re-schedule timeout event */</span></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Callback for state changes on the Client */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">avahi_client_callback (AVAHI_GCC_UNUSED <a class="code" href="client_8h.html#a3d65e9ea7182c44fa8df04a72f1a56bb">AvahiClient</a> *client, <a class="code" href="client_8h.html#aaf9074b91ffd35b940e09448a9cd45e9">AvahiClientState</a> state, <span class="keywordtype">void</span> *userdata)</div>
<div class="line">{</div>
<div class="line">    GMainLoop *loop = userdata;</div>
<div class="line"></div>
<div class="line">    g_message (<span class="stringliteral">&quot;Avahi Client State Change: %d&quot;</span>, state);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (state == <a name="a0"></a><a class="code" href="client_8h.html#aaf9074b91ffd35b940e09448a9cd45e9a04583aa28fec0f0987fd2d3a1814db4b">AVAHI_CLIENT_FAILURE</a>)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">/* We we&#39;re disconnected from the Daemon */</span></div>
<div class="line">        g_message (<span class="stringliteral">&quot;Disconnected from the Avahi Daemon: %s&quot;</span>, <a name="a1"></a><a class="code" href="error_8h.html#acb801f36563fde5d25b0b2b2cae8dfe0">avahi_strerror</a>(<a name="a2"></a><a class="code" href="client_8h.html#a763d48f8147ab488456705970ea20e44">avahi_client_errno</a>(client)));</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Quit the application */</span></div>
<div class="line">        g_main_loop_quit (loop);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">main (AVAHI_GCC_UNUSED <span class="keywordtype">int</span> argc, AVAHI_GCC_UNUSED <span class="keywordtype">char</span> *argv[])</div>
<div class="line">{</div>
<div class="line">    GMainLoop *loop = NULL;</div>
<div class="line">    <span class="keyword">const</span> <a name="_a3"></a><a class="code" href="struct_avahi_poll.html">AvahiPoll</a> *poll_api;</div>
<div class="line">    <a class="code" href="glib-watch_8h.html#adbe6a8c5897e02573fa709cfc79423a6">AvahiGLibPoll</a> *glib_poll;</div>
<div class="line">    <a class="code" href="client_8h.html#a3d65e9ea7182c44fa8df04a72f1a56bb">AvahiClient</a> *client;</div>
<div class="line">    <span class="keyword">struct </span>timeval tv;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *version;</div>
<div class="line">    <span class="keywordtype">int</span> error;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Optional: Tell avahi to use g_malloc and g_free */</span></div>
<div class="line">    <a name="a4"></a><a class="code" href="malloc_8h.html#accd9f7a4ce488082ff2681c381f7d035">avahi_set_allocator</a> (<a name="a5"></a><a class="code" href="glib-malloc_8h.html#ac38f00910c8f2827f72ac9dcb4d9f57f">avahi_glib_allocator</a> ());</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Create the GLIB main loop */</span></div>
<div class="line">    loop = g_main_loop_new (NULL, FALSE);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Create the GLIB Adaptor */</span></div>
<div class="line">    glib_poll = <a name="a6"></a><a class="code" href="glib-watch_8h.html#a7605e1f832a19c7910a47f90059652cb">avahi_glib_poll_new</a> (NULL, G_PRIORITY_DEFAULT);</div>
<div class="line">    poll_api = <a name="a7"></a><a class="code" href="glib-watch_8h.html#a9d53612fea4caa5266ac43014226e147">avahi_glib_poll_get</a> (glib_poll);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Example, schedule a timeout event with the Avahi API */</span></div>
<div class="line">    avahi_elapse_time (&amp;tv,                         <span class="comment">/* timeval structure */</span></div>
<div class="line">            1000,                                   <span class="comment">/* 1 second */</span></div>
<div class="line">            0);                                     <span class="comment">/* &quot;jitter&quot; - Random additional delay from 0 to this value */</span></div>
<div class="line"></div>
<div class="line">    poll_api-&gt;<a name="a8"></a><a class="code" href="struct_avahi_poll.html#abc2890fd69c1753aae84fb8e48044be4">timeout_new</a> (poll_api,                <span class="comment">/* The AvahiPoll object */</span></div>
<div class="line">                      &amp;tv,                          <span class="comment">/* struct timeval indicating when to go activate */</span></div>
<div class="line">                      avahi_timeout_event,          <span class="comment">/* Pointer to function to call */</span></div>
<div class="line">                      NULL);                        <span class="comment">/* User data to pass to function */</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Schedule a timeout event with the glib api */</span></div>
<div class="line">    g_timeout_add (5000,                            <span class="comment">/* 5 seconds */</span></div>
<div class="line">            avahi_timeout_event_glib,               <span class="comment">/* Pointer to function callback */</span></div>
<div class="line">            loop);                                  <span class="comment">/* User data to pass to function */</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Create a new AvahiClient instance */</span></div>
<div class="line">    client = <a name="a9"></a><a class="code" href="client_8h.html#a07b2a33a3e7cbb18a0eb9d00eade6ae6">avahi_client_new</a> (poll_api,            <span class="comment">/* AvahiPoll object from above */</span></div>
<div class="line">                               0,</div>
<div class="line">            avahi_client_callback,                  <span class="comment">/* Callback function for Client state changes */</span></div>
<div class="line">            loop,                                   <span class="comment">/* User data */</span></div>
<div class="line">            &amp;error);                                <span class="comment">/* Error return */</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Check the error return code */</span></div>
<div class="line">    <span class="keywordflow">if</span> (client == NULL)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">/* Print out the error string */</span></div>
<div class="line">        g_warning (<span class="stringliteral">&quot;Error initializing Avahi: %s&quot;</span>, <a class="code" href="error_8h.html#acb801f36563fde5d25b0b2b2cae8dfe0">avahi_strerror</a> (error));</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">goto</span> fail;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Make a call to get the version string from the daemon */</span></div>
<div class="line">    version = <a name="a10"></a><a class="code" href="client_8h.html#aaa1a26c98dcc8fc0b2b5fba453ae20cf">avahi_client_get_version_string</a> (client);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Check if the call suceeded */</span></div>
<div class="line">    <span class="keywordflow">if</span> (version == NULL)</div>
<div class="line">    {</div>
<div class="line">        g_warning (<span class="stringliteral">&quot;Error getting version string: %s&quot;</span>, <a class="code" href="error_8h.html#acb801f36563fde5d25b0b2b2cae8dfe0">avahi_strerror</a> (<a class="code" href="client_8h.html#a763d48f8147ab488456705970ea20e44">avahi_client_errno</a> (client)));</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">goto</span> fail;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    g_message (<span class="stringliteral">&quot;Avahi Server Version: %s&quot;</span>, version);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Start the GLIB Main Loop */</span></div>
<div class="line">    g_main_loop_run (loop);</div>
<div class="line"></div>
<div class="line">fail:</div>
<div class="line">    <span class="comment">/* Clean up */</span></div>
<div class="line">    g_main_loop_unref (loop);</div>
<div class="line">    <a name="a11"></a><a class="code" href="client_8h.html#aceb92c59523def4de9f745f4149cb392">avahi_client_free</a> (client);</div>
<div class="line">    <a name="a12"></a><a class="code" href="glib-watch_8h.html#adb35c3bc5773317e239f98ab2d883fcf">avahi_glib_poll_free</a> (glib_poll);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon Mar 23 2015 10:02:04 for avahi by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.9.1 </li>
  </ul>
</div>
</body>
</html>
