<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>avahi: client-publish-service.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">avahi
   &#160;<span id="projectnumber">0.7</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('client-publish-service_8c-example.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">client-publish-service.c</div>  </div>
</div><!--header-->
<div class="contents">
<p>Example how to register a DNS-SD service using the client interface to avahi-daemon. It behaves like a network printer registering both an IPP and a BSD LPR service.</p>
<div class="fragment"><div class="line"><span class="comment">/***</span></div><div class="line"><span class="comment">  This file is part of avahi.</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">  avahi is free software; you can redistribute it and/or modify it</span></div><div class="line"><span class="comment">  under the terms of the GNU Lesser General Public License as</span></div><div class="line"><span class="comment">  published by the Free Software Foundation; either version 2.1 of the</span></div><div class="line"><span class="comment">  License, or (at your option) any later version.</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">  avahi is distributed in the hope that it will be useful, but WITHOUT</span></div><div class="line"><span class="comment">  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY</span></div><div class="line"><span class="comment">  or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Lesser General</span></div><div class="line"><span class="comment">  Public License for more details.</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">  You should have received a copy of the GNU Lesser General Public</span></div><div class="line"><span class="comment">  License along with avahi; if not, write to the Free Software</span></div><div class="line"><span class="comment">  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307</span></div><div class="line"><span class="comment">  USA.</span></div><div class="line"><span class="comment">***/</span></div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef HAVE_CONFIG_H</span></div><div class="line"><span class="preprocessor">#include &lt;config.h&gt;</span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;time.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;assert.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="client_8h.html">avahi-client/client.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="publish_8h.html">avahi-client/publish.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="alternative_8h.html">avahi-common/alternative.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="simple-watch_8h.html">avahi-common/simple-watch.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="malloc_8h.html">avahi-common/malloc.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="error_8h.html">avahi-common/error.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;avahi-common/timeval.h&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <a class="code" href="publish_8h.html#ab6622b54fce4299a56ba12421be4e985">AvahiEntryGroup</a> *group = NULL;</div><div class="line"><span class="keyword">static</span> <a class="code" href="simple-watch_8h.html#a0e40ccdfdc9d60e7baf0c312347f79b2">AvahiSimplePoll</a> *simple_poll = NULL;</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">char</span> *name = NULL;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> create_services(<a class="code" href="client_8h.html#a3d65e9ea7182c44fa8df04a72f1a56bb">AvahiClient</a> *c);</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> entry_group_callback(<a class="code" href="publish_8h.html#ab6622b54fce4299a56ba12421be4e985">AvahiEntryGroup</a> *g, <a class="code" href="defs_8h.html#a141829383c5b97e9c0fa75ca0e590217">AvahiEntryGroupState</a> state, AVAHI_GCC_UNUSED <span class="keywordtype">void</span> *userdata) {</div><div class="line">    assert(g == group || group == NULL);</div><div class="line">    group = g;</div><div class="line"></div><div class="line">    <span class="comment">/* Called whenever the entry group state changes */</span></div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span> (state) {</div><div class="line">        <span class="keywordflow">case</span> <a name="a0"></a><a class="code" href="defs_8h.html#a141829383c5b97e9c0fa75ca0e590217acdb3fe1295e58561c666cbf7ee6adf5a">AVAHI_ENTRY_GROUP_ESTABLISHED</a> :</div><div class="line">            <span class="comment">/* The entry group has been established successfully */</span></div><div class="line">            fprintf(stderr, <span class="stringliteral">&quot;Service &#39;%s&#39; successfully established.\n&quot;</span>, name);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">        <span class="keywordflow">case</span> <a name="a1"></a><a class="code" href="defs_8h.html#a141829383c5b97e9c0fa75ca0e590217a8f163dbd719eb71f404f89415d8c9f3e">AVAHI_ENTRY_GROUP_COLLISION</a> : {</div><div class="line">            <span class="keywordtype">char</span> *n;</div><div class="line"></div><div class="line">            <span class="comment">/* A service name collision with a remote service</span></div><div class="line"><span class="comment">             * happened. Let&#39;s pick a new name */</span></div><div class="line">            n = <a name="a2"></a><a class="code" href="alternative_8h.html#ae0b973d05cf10ee64ff755cff0b85d14">avahi_alternative_service_name</a>(name);</div><div class="line">            <a name="a3"></a><a class="code" href="malloc_8h.html#af0d93804e70823f30f7680d2f8845ed4">avahi_free</a>(name);</div><div class="line">            name = n;</div><div class="line"></div><div class="line">            fprintf(stderr, <span class="stringliteral">&quot;Service name collision, renaming service to &#39;%s&#39;\n&quot;</span>, name);</div><div class="line"></div><div class="line">            <span class="comment">/* And recreate the services */</span></div><div class="line">            create_services(<a name="a4"></a><a class="code" href="publish_8h.html#a5a0a69e977bb46bf7ab69002c509a040">avahi_entry_group_get_client</a>(g));</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">case</span> <a name="a5"></a><a class="code" href="defs_8h.html#a141829383c5b97e9c0fa75ca0e590217a83adf26c6d556c2f4ce32cce3a62030e">AVAHI_ENTRY_GROUP_FAILURE</a> :</div><div class="line"></div><div class="line">            fprintf(stderr, <span class="stringliteral">&quot;Entry group failure: %s\n&quot;</span>, <a name="a6"></a><a class="code" href="error_8h.html#acb801f36563fde5d25b0b2b2cae8dfe0">avahi_strerror</a>(<a name="a7"></a><a class="code" href="client_8h.html#a763d48f8147ab488456705970ea20e44">avahi_client_errno</a>(<a class="code" href="publish_8h.html#a5a0a69e977bb46bf7ab69002c509a040">avahi_entry_group_get_client</a>(g))));</div><div class="line"></div><div class="line">            <span class="comment">/* Some kind of failure happened while we were registering our services */</span></div><div class="line">            <a name="a8"></a><a class="code" href="simple-watch_8h.html#ac2771664e4e6c7e75e5b5a270e5e0490">avahi_simple_poll_quit</a>(simple_poll);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">        <span class="keywordflow">case</span> <a name="a9"></a><a class="code" href="defs_8h.html#a141829383c5b97e9c0fa75ca0e590217a6afdc2228658792da73171e5b26dc328">AVAHI_ENTRY_GROUP_UNCOMMITED</a>:</div><div class="line">        <span class="keywordflow">case</span> <a name="a10"></a><a class="code" href="defs_8h.html#a141829383c5b97e9c0fa75ca0e590217a5627957ceaf2fdd51e1f2585aa871213">AVAHI_ENTRY_GROUP_REGISTERING</a>:</div><div class="line">            ;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> create_services(<a class="code" href="client_8h.html#a3d65e9ea7182c44fa8df04a72f1a56bb">AvahiClient</a> *c) {</div><div class="line">    <span class="keywordtype">char</span> *n, r[128];</div><div class="line">    <span class="keywordtype">int</span> ret;</div><div class="line">    assert(c);</div><div class="line"></div><div class="line">    <span class="comment">/* If this is the first time we&#39;re called, let&#39;s create a new</span></div><div class="line"><span class="comment">     * entry group if necessary */</span></div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (!group)</div><div class="line">        <span class="keywordflow">if</span> (!(group = <a name="a11"></a><a class="code" href="publish_8h.html#abb17598f2b6ec3c3f69defdd488d568c">avahi_entry_group_new</a>(c, entry_group_callback, NULL))) {</div><div class="line">            fprintf(stderr, <span class="stringliteral">&quot;avahi_entry_group_new() failed: %s\n&quot;</span>, <a class="code" href="error_8h.html#acb801f36563fde5d25b0b2b2cae8dfe0">avahi_strerror</a>(<a class="code" href="client_8h.html#a763d48f8147ab488456705970ea20e44">avahi_client_errno</a>(c)));</div><div class="line">            <span class="keywordflow">goto</span> fail;</div><div class="line">        }</div><div class="line"></div><div class="line">    <span class="comment">/* If the group is empty (either because it was just created, or</span></div><div class="line"><span class="comment">     * because it was reset previously, add our entries.  */</span></div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (<a name="a12"></a><a class="code" href="publish_8h.html#af5a78ee1fda6678970536889d459d85c">avahi_entry_group_is_empty</a>(group)) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Adding service &#39;%s&#39;\n&quot;</span>, name);</div><div class="line"></div><div class="line">        <span class="comment">/* Create some random TXT data */</span></div><div class="line">        snprintf(r, <span class="keyword">sizeof</span>(r), <span class="stringliteral">&quot;random=%i&quot;</span>, rand());</div><div class="line"></div><div class="line">        <span class="comment">/* We will now add two services and one subtype to the entry</span></div><div class="line"><span class="comment">         * group. The two services have the same name, but differ in</span></div><div class="line"><span class="comment">         * the service type (IPP vs. BSD LPR). Only services with the</span></div><div class="line"><span class="comment">         * same name should be put in the same entry group. */</span></div><div class="line"></div><div class="line">        <span class="comment">/* Add the service for IPP */</span></div><div class="line">        <span class="keywordflow">if</span> ((ret = <a name="a13"></a><a class="code" href="publish_8h.html#acb05a7d3d23a3b825ca77cb1c7d00ce4">avahi_entry_group_add_service</a>(group, <a name="a14"></a><a class="code" href="address_8h.html#adf764cbdea00d65edcd07bb9953ad2b7a9cefc02b2cc49f5a4c8effb3f610cca6">AVAHI_IF_UNSPEC</a>, <a name="a15"></a><a class="code" href="address_8h.html#a06fc87d81c62e9abb8790b6e5713c55ba6c1837afa356a983f188e35911dc0d84">AVAHI_PROTO_UNSPEC</a>, 0, name, <span class="stringliteral">&quot;_ipp._tcp&quot;</span>, NULL, NULL, 651, <span class="stringliteral">&quot;test=blah&quot;</span>, r, NULL)) &lt; 0) {</div><div class="line"></div><div class="line">            <span class="keywordflow">if</span> (ret == <a name="a16"></a><a class="code" href="error_8h.html#a61dadd085c1777f559549e05962b2c9ea5162d9b82323f79097bb72ffdab3dda5">AVAHI_ERR_COLLISION</a>)</div><div class="line">                <span class="keywordflow">goto</span> collision;</div><div class="line"></div><div class="line">            fprintf(stderr, <span class="stringliteral">&quot;Failed to add _ipp._tcp service: %s\n&quot;</span>, <a class="code" href="error_8h.html#acb801f36563fde5d25b0b2b2cae8dfe0">avahi_strerror</a>(ret));</div><div class="line">            <span class="keywordflow">goto</span> fail;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* Add the same service for BSD LPR */</span></div><div class="line">        <span class="keywordflow">if</span> ((ret = <a class="code" href="publish_8h.html#acb05a7d3d23a3b825ca77cb1c7d00ce4">avahi_entry_group_add_service</a>(group, <a class="code" href="address_8h.html#adf764cbdea00d65edcd07bb9953ad2b7a9cefc02b2cc49f5a4c8effb3f610cca6">AVAHI_IF_UNSPEC</a>, <a class="code" href="address_8h.html#a06fc87d81c62e9abb8790b6e5713c55ba6c1837afa356a983f188e35911dc0d84">AVAHI_PROTO_UNSPEC</a>, 0, name, <span class="stringliteral">&quot;_printer._tcp&quot;</span>, NULL, NULL, 515, NULL)) &lt; 0) {</div><div class="line"></div><div class="line">            <span class="keywordflow">if</span> (ret == <a class="code" href="error_8h.html#a61dadd085c1777f559549e05962b2c9ea5162d9b82323f79097bb72ffdab3dda5">AVAHI_ERR_COLLISION</a>)</div><div class="line">                <span class="keywordflow">goto</span> collision;</div><div class="line"></div><div class="line">            fprintf(stderr, <span class="stringliteral">&quot;Failed to add _printer._tcp service: %s\n&quot;</span>, <a class="code" href="error_8h.html#acb801f36563fde5d25b0b2b2cae8dfe0">avahi_strerror</a>(ret));</div><div class="line">            <span class="keywordflow">goto</span> fail;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* Add an additional (hypothetic) subtype */</span></div><div class="line">        <span class="keywordflow">if</span> ((ret = <a name="a17"></a><a class="code" href="publish_8h.html#a93841be69a152d3134b408c25bb4d5d5">avahi_entry_group_add_service_subtype</a>(group, <a class="code" href="address_8h.html#adf764cbdea00d65edcd07bb9953ad2b7a9cefc02b2cc49f5a4c8effb3f610cca6">AVAHI_IF_UNSPEC</a>, <a class="code" href="address_8h.html#a06fc87d81c62e9abb8790b6e5713c55ba6c1837afa356a983f188e35911dc0d84">AVAHI_PROTO_UNSPEC</a>, 0, name, <span class="stringliteral">&quot;_printer._tcp&quot;</span>, NULL, <span class="stringliteral">&quot;_magic._sub._printer._tcp&quot;</span>) &lt; 0)) {</div><div class="line">            fprintf(stderr, <span class="stringliteral">&quot;Failed to add subtype _magic._sub._printer._tcp: %s\n&quot;</span>, <a class="code" href="error_8h.html#acb801f36563fde5d25b0b2b2cae8dfe0">avahi_strerror</a>(ret));</div><div class="line">            <span class="keywordflow">goto</span> fail;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* Tell the server to register the service */</span></div><div class="line">        <span class="keywordflow">if</span> ((ret = <a name="a18"></a><a class="code" href="publish_8h.html#a2375338d23af4281399404758840a2de">avahi_entry_group_commit</a>(group)) &lt; 0) {</div><div class="line">            fprintf(stderr, <span class="stringliteral">&quot;Failed to commit entry group: %s\n&quot;</span>, <a class="code" href="error_8h.html#acb801f36563fde5d25b0b2b2cae8dfe0">avahi_strerror</a>(ret));</div><div class="line">            <span class="keywordflow">goto</span> fail;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span>;</div><div class="line"></div><div class="line">collision:</div><div class="line"></div><div class="line">    <span class="comment">/* A service name collision with a local service happened. Let&#39;s</span></div><div class="line"><span class="comment">     * pick a new name */</span></div><div class="line">    n = <a class="code" href="alternative_8h.html#ae0b973d05cf10ee64ff755cff0b85d14">avahi_alternative_service_name</a>(name);</div><div class="line">    <a class="code" href="malloc_8h.html#af0d93804e70823f30f7680d2f8845ed4">avahi_free</a>(name);</div><div class="line">    name = n;</div><div class="line"></div><div class="line">    fprintf(stderr, <span class="stringliteral">&quot;Service name collision, renaming service to &#39;%s&#39;\n&quot;</span>, name);</div><div class="line"></div><div class="line">    <a name="a19"></a><a class="code" href="publish_8h.html#a1293bbccf878dbeb9916660022bc71b2">avahi_entry_group_reset</a>(group);</div><div class="line"></div><div class="line">    create_services(c);</div><div class="line">    <span class="keywordflow">return</span>;</div><div class="line"></div><div class="line">fail:</div><div class="line">    <a class="code" href="simple-watch_8h.html#ac2771664e4e6c7e75e5b5a270e5e0490">avahi_simple_poll_quit</a>(simple_poll);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> client_callback(<a class="code" href="client_8h.html#a3d65e9ea7182c44fa8df04a72f1a56bb">AvahiClient</a> *c, <a class="code" href="client_8h.html#aaf9074b91ffd35b940e09448a9cd45e9">AvahiClientState</a> state, AVAHI_GCC_UNUSED <span class="keywordtype">void</span> * userdata) {</div><div class="line">    assert(c);</div><div class="line"></div><div class="line">    <span class="comment">/* Called whenever the client or server state changes */</span></div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span> (state) {</div><div class="line">        <span class="keywordflow">case</span> <a name="a20"></a><a class="code" href="client_8h.html#aaf9074b91ffd35b940e09448a9cd45e9aa938fb22163a04c7b30722aa7827c125">AVAHI_CLIENT_S_RUNNING</a>:</div><div class="line"></div><div class="line">            <span class="comment">/* The server has startup successfully and registered its host</span></div><div class="line"><span class="comment">             * name on the network, so it&#39;s time to create our services */</span></div><div class="line">            create_services(c);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">        <span class="keywordflow">case</span> <a name="a21"></a><a class="code" href="client_8h.html#aaf9074b91ffd35b940e09448a9cd45e9a04583aa28fec0f0987fd2d3a1814db4b">AVAHI_CLIENT_FAILURE</a>:</div><div class="line"></div><div class="line">            fprintf(stderr, <span class="stringliteral">&quot;Client failure: %s\n&quot;</span>, <a class="code" href="error_8h.html#acb801f36563fde5d25b0b2b2cae8dfe0">avahi_strerror</a>(<a class="code" href="client_8h.html#a763d48f8147ab488456705970ea20e44">avahi_client_errno</a>(c)));</div><div class="line">            <a class="code" href="simple-watch_8h.html#ac2771664e4e6c7e75e5b5a270e5e0490">avahi_simple_poll_quit</a>(simple_poll);</div><div class="line"></div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">        <span class="keywordflow">case</span> <a name="a22"></a><a class="code" href="client_8h.html#aaf9074b91ffd35b940e09448a9cd45e9afb8608994e0d88eaedacd31a46f54ec5">AVAHI_CLIENT_S_COLLISION</a>:</div><div class="line"></div><div class="line">            <span class="comment">/* Let&#39;s drop our registered services. When the server is back</span></div><div class="line"><span class="comment">             * in AVAHI_SERVER_RUNNING state we will register them</span></div><div class="line"><span class="comment">             * again with the new host name. */</span></div><div class="line"></div><div class="line">        <span class="keywordflow">case</span> <a name="a23"></a><a class="code" href="client_8h.html#aaf9074b91ffd35b940e09448a9cd45e9aab8998306026f5c6d1984fd99f8d3a33">AVAHI_CLIENT_S_REGISTERING</a>:</div><div class="line"></div><div class="line">            <span class="comment">/* The server records are now being established. This</span></div><div class="line"><span class="comment">             * might be caused by a host name change. We need to wait</span></div><div class="line"><span class="comment">             * for our own records to register until the host name is</span></div><div class="line"><span class="comment">             * properly esatblished. */</span></div><div class="line"></div><div class="line">            <span class="keywordflow">if</span> (group)</div><div class="line">                <a class="code" href="publish_8h.html#a1293bbccf878dbeb9916660022bc71b2">avahi_entry_group_reset</a>(group);</div><div class="line"></div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">        <span class="keywordflow">case</span> <a name="a24"></a><a class="code" href="client_8h.html#aaf9074b91ffd35b940e09448a9cd45e9a0edc78ba86f12b22407707fe63b8fbfa">AVAHI_CLIENT_CONNECTING</a>:</div><div class="line">            ;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> modify_callback(AVAHI_GCC_UNUSED <a class="code" href="watch_8h.html#a7c49ec2c98706902366ce0f74958626d">AvahiTimeout</a> *e, <span class="keywordtype">void</span> *userdata) {</div><div class="line">    <a class="code" href="client_8h.html#a3d65e9ea7182c44fa8df04a72f1a56bb">AvahiClient</a> *client = userdata;</div><div class="line"></div><div class="line">    fprintf(stderr, <span class="stringliteral">&quot;Doing some weird modification\n&quot;</span>);</div><div class="line"></div><div class="line">    <a class="code" href="malloc_8h.html#af0d93804e70823f30f7680d2f8845ed4">avahi_free</a>(name);</div><div class="line">    name = <a name="a25"></a><a class="code" href="malloc_8h.html#a8b3595843b0c658fef2131640b8a549f">avahi_strdup</a>(<span class="stringliteral">&quot;Modified MegaPrinter&quot;</span>);</div><div class="line"></div><div class="line">    <span class="comment">/* If the server is currently running, we need to remove our</span></div><div class="line"><span class="comment">     * service and create it anew */</span></div><div class="line">    <span class="keywordflow">if</span> (<a name="a26"></a><a class="code" href="client_8h.html#a3c392604bac6c14522e90bb78b1e17bd">avahi_client_get_state</a>(client) == <a class="code" href="client_8h.html#aaf9074b91ffd35b940e09448a9cd45e9aa938fb22163a04c7b30722aa7827c125">AVAHI_CLIENT_S_RUNNING</a>) {</div><div class="line"></div><div class="line">        <span class="comment">/* Remove the old services */</span></div><div class="line">        <span class="keywordflow">if</span> (group)</div><div class="line">            <a class="code" href="publish_8h.html#a1293bbccf878dbeb9916660022bc71b2">avahi_entry_group_reset</a>(group);</div><div class="line"></div><div class="line">        <span class="comment">/* And create them again with the new name */</span></div><div class="line">        create_services(client);</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main(AVAHI_GCC_UNUSED <span class="keywordtype">int</span> argc, AVAHI_GCC_UNUSED <span class="keywordtype">char</span>*argv[]) {</div><div class="line">    <a class="code" href="client_8h.html#a3d65e9ea7182c44fa8df04a72f1a56bb">AvahiClient</a> *client = NULL;</div><div class="line">    <span class="keywordtype">int</span> error;</div><div class="line">    <span class="keywordtype">int</span> ret = 1;</div><div class="line">    <span class="keyword">struct </span>timeval tv;</div><div class="line"></div><div class="line">    <span class="comment">/* Allocate main loop object */</span></div><div class="line">    <span class="keywordflow">if</span> (!(simple_poll = <a name="a27"></a><a class="code" href="simple-watch_8h.html#a4548a645c8ae50edd0617c8d9a15a9bd">avahi_simple_poll_new</a>())) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Failed to create simple poll object.\n&quot;</span>);</div><div class="line">        <span class="keywordflow">goto</span> fail;</div><div class="line">    }</div><div class="line"></div><div class="line">    name = <a class="code" href="malloc_8h.html#a8b3595843b0c658fef2131640b8a549f">avahi_strdup</a>(<span class="stringliteral">&quot;MegaPrinter&quot;</span>);</div><div class="line"></div><div class="line">    <span class="comment">/* Allocate a new client */</span></div><div class="line">    client = <a name="a28"></a><a class="code" href="client_8h.html#a07b2a33a3e7cbb18a0eb9d00eade6ae6">avahi_client_new</a>(<a name="a29"></a><a class="code" href="simple-watch_8h.html#a8e7a53b4116c2379d04f8298398e59e8">avahi_simple_poll_get</a>(simple_poll), 0, client_callback, NULL, &amp;error);</div><div class="line"></div><div class="line">    <span class="comment">/* Check wether creating the client object succeeded */</span></div><div class="line">    <span class="keywordflow">if</span> (!client) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Failed to create client: %s\n&quot;</span>, <a class="code" href="error_8h.html#acb801f36563fde5d25b0b2b2cae8dfe0">avahi_strerror</a>(error));</div><div class="line">        <span class="keywordflow">goto</span> fail;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* After 10s do some weird modification to the service */</span></div><div class="line">    <a class="code" href="simple-watch_8h.html#a8e7a53b4116c2379d04f8298398e59e8">avahi_simple_poll_get</a>(simple_poll)-&gt;<a name="a30"></a><a class="code" href="struct_avahi_poll.html#abc2890fd69c1753aae84fb8e48044be4">timeout_new</a>(</div><div class="line">        <a class="code" href="simple-watch_8h.html#a8e7a53b4116c2379d04f8298398e59e8">avahi_simple_poll_get</a>(simple_poll),</div><div class="line">        avahi_elapse_time(&amp;tv, 1000*10, 0),</div><div class="line">        modify_callback,</div><div class="line">        client);</div><div class="line"></div><div class="line">    <span class="comment">/* Run the main loop */</span></div><div class="line">    <a name="a31"></a><a class="code" href="simple-watch_8h.html#a14b4cb29832e8c3de609d4c4e5611985">avahi_simple_poll_loop</a>(simple_poll);</div><div class="line"></div><div class="line">    ret = 0;</div><div class="line"></div><div class="line">fail:</div><div class="line"></div><div class="line">    <span class="comment">/* Cleanup things */</span></div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (client)</div><div class="line">        <a name="a32"></a><a class="code" href="client_8h.html#aceb92c59523def4de9f745f4149cb392">avahi_client_free</a>(client);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (simple_poll)</div><div class="line">        <a name="a33"></a><a class="code" href="simple-watch_8h.html#a2d23c812725d77cf4c6478d249bb434e">avahi_simple_poll_free</a>(simple_poll);</div><div class="line"></div><div class="line">    <a class="code" href="malloc_8h.html#af0d93804e70823f30f7680d2f8845ed4">avahi_free</a>(name);</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> ret;</div><div class="line">}</div></div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
